{% extends 'base.html.twig' %}

{% block title %}{{site.name}} | Accueil{% endblock %}

{% block stylesheets %}
 
<!-- BEGIN PAGE LEVEL PLUGINS/CUSTOM STYLES -->
<link href="/css/scrollspyNav.css" rel="stylesheet" type="text/css">
<link href="/plugins/animate/animate.css" rel="stylesheet" type="text/css">
<script src="/plugins/sweetalerts/promise-polyfill.js"></script>
<link href="/plugins/sweetalerts/sweetalert2.min.css" rel="stylesheet" type="text/css">
<link href="/plugins/sweetalerts/sweetalert.css" rel="stylesheet" type="text/css">
<link href="/css/components/custom-sweetalert.css" rel="stylesheet" type="text/css">
<link href="/css/components/tabs-accordian/custom-tabs.css" rel="stylesheet" type="text/css">
<link href="/plugins/apex/apexcharts.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/widgets/modules-widgets.css">  
<link rel="stylesheet" type="text/css" href="/plugins/table/datatable/datatables.css">
<link rel="stylesheet" type="text/css" href="/plugins/table/datatable/dt-global_style.css">
<link href="/plugins/daterangepicker/daterangepicker.css" rel="stylesheet" />
<link href="/css/components/custom-modal.css" rel="stylesheet" type="text/css" />
<!-- Sweet Alert -->
<link href="/plugins/sweet-alert2/sweetalert2.min.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>

{# <style>
    .gauge {
        width: 100%;
        height: 100%;
    }
    .size-2 {
        width: 100px;
        height: 150px;
        /*width: 90px;
        height: 120px;*/
        margin: 30px auto 0 auto;
        text-align: center;
        /*border: 1px solid #e9ecef;*/
        padding: 5px;
    }

    #canvas {
        /*margin-left: 0px;
        margin-right: 0px;
        background: #888ea8;*/
        
        /*border: thin solid #aaaaaa;*/
    }
</style>   #}
{% endblock %}

{% block body %}
    <div class="border-top-tab">
        <div class="row widget-statistic layout-top-spacing">

            <div class="col-xl-9 col-lg-9 col-md-9 col-sm-9 col-12 layout-spacing" >
                <div class="row mt-3"><small class="text-left h6">Date de dernière Mise à jour : <span id="last_update">{{gensetData['last_update']}}</span></small></div>
                <div style="position:relative;">
                    <div class="row" >
                        <div class="col">
                            <div class="row layout-top-spacing ">
                            
                                <div class="widget widget-one_hybrid widget-grid-site" style="z-index: 2;">
                                    <div class="widget-heading">
                                        <div class="w-icon">
                                            <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M8.28,5.45L6.5,4.55L7.76,2H16.23L17.5,4.55L15.72,5.44L15,4H9L8.28,5.45M18.62,8H14.09L13.3,5H10.7L9.91,8H5.38L4.1,10.55L5.89,11.44L6.62,10H17.38L18.1,11.45L19.89,10.56L18.62,8M17.77,22H15.7L15.46,21.1L12,15.9L8.53,21.1L8.3,22H6.23L9.12,11H11.19L10.83,12.35L12,14.1L13.16,12.35L12.81,11H14.88L17.77,22M11.4,15L10.5,13.65L9.32,18.13L11.4,15M14.68,18.12L13.5,13.64L12.6,15L14.68,18.12Z" /></svg>
                                        </div>
                                        <div class="source-name">GRID</div>
                                        <p class="w-value text-center"><span id="grid-kW">{% if gensetData['CGCR']['CR'] %}{{gensetData['Power']}}{% else %}0.0{% endif %}</span> kW</p>
                                        {# <h5 class="">Consommation du mois en cours</h5> #}
                                    </div>
                                    <div class="widget-content">    
                                        <div class="w-chart">
                                            <div id="w-load-chart-grid"></div>
                                        </div>

                                        <div class="row ml-2 mt-2" style="font-size:12px">
                                            <div class="col">Fourniture</div>
                                            <div class="col"><span id="w-grid-fourniture">{{gridData['totalKWh']}}</span> kWh</div>
                                        </div>
                                        <div class="row ml-2" style="font-size:12px">
                                            <div class="col">Contribution</div>
                                            <div class="col"><span id="w-grid-contrib">{{gridData['contrib']}}</span> %</div>
                                        </div>
                                        <div class="row ml-2" style="font-size:12px">
                                            <div class="col">FP</div>
                                            <div class="col"><span id="w-grid-fp">{{gridData['FP']}}</span></div>
                                        </div>
                                        <div class="row ml-2 mb-2" style="font-size:12px">
                                            <div class="col">Pmax</div>
                                            <div class="col"><span id="w-grid-pmax">{{gridData['Pmax']}}</span> kW</div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            
                            <div class="row layout-top-spacing">
                                
                                <div class="widget widget-one_hybrid widget-genset-site" style="z-index: 2;">
                                    <div class="widget-heading">
                                        <div class="w-icon source-name">
                                            {# <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M8,10H16V18H11L9,16H7V11M7,4V6H10V8H7L5,10V13H3V10H1V18H3V15H5V18H8L10,20H18V16H20V19H23V9H20V12H18V8H12V6H15V4H7Z" /></svg> #}
                                            <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M8,10H16V18H11L9,16H7V11M7,4V6H10V8H7L5,10V13H3V10H1V18H3V15H5V18H8L10,20H18V16H20V19H23V9H20V12H18V8H12V6H15V4H7Z" /></svg>
                                        </div>
                                        <div class="source-name"><a href="{% if isGensetFuel == true %}{{ path('genset_home', {'slug':site.slug,'id':gensetId}) }}{% else %}#{% endif %}" style="color:#e26b1b">Genset</a></div>
                                        {# <div class="source-name"><a href="#" style="color:#e26b1b">Genset</a></div> #}
                                        <p class="w-value text-center">{% if hasgensetMod %}<span id="genset-kW">{% if gensetData['CGCR']['CG'] %}{{gensetData['Power']}}{% else %}0.0{% endif %}</span> kW{% else %} - {% endif %}</p>
                                        
                                    </div>
                                    <div class="widget-content">    
                                        <div class="w-chart">
                                            <div id="w-load-chart-genset"></div>
                                        </div>

                                        <div class="row ml-2 mt-2" style="font-size:12px">
                                            <div class="col">Fourniture</div>
                                            <div class="col">{% if hasgensetMod %}<span id="w-genset-fourniture">{{gensetData['currentTEP']}}</span> kWh{% else %}-{% endif %}</div>
                                        </div>
                                        <div class="row ml-2" style="font-size:12px">
                                            <div class="col">Contribution</div>
                                            <div class="col">{% if hasgensetMod %}<span id="w-genset-contrib">{{contriGensetKWh}}</span> %{% else %}-{% endif %}</div>
                                        </div>
                                        {% if isGensetFuel == true %}
                                        <div class="row ml-2" style="font-size:12px">
                                            <div class="col">Conso Fuel : </div>
                                            <div class="col"><span id="w-genset-conso-fuel">{{gensetData['currentConsoFuel']}}</span> L</div>
                                        </div>
                                        {% endif %}
                                        <div class="row ml-2 mb-2" style="font-size:12px">
                                            <div class="col">Charge Max</div>
                                            <div class="col">{% if hasgensetMod %}<span id="w-genset-load-max">{{gensetData['loadMax']}}</span> %{% else %}-{% endif %}</div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>

                        <div class="col mb-5">
                            <div class="widget widget-one_hybrid widget-load-site" style="z-index: 2;">
                                <div class="widget-heading">
                                    <div class="w-icon source-name">
                                        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="plug" class="svg-inline--fa fa-plug fa-w-12" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M320,32a32,32,0,0,0-64,0v96h64Zm48,128H16A16,16,0,0,0,0,176v32a16,16,0,0,0,16,16H32v32A160.07,160.07,0,0,0,160,412.8V512h64V412.8A160.07,160.07,0,0,0,352,256V224h16a16,16,0,0,0,16-16V176A16,16,0,0,0,368,160ZM128,32a32,32,0,0,0-64,0v96h64Z"></path></svg>
                                    </div>
                                    <div class="source-name">Charge</div>
{#                                    <p class="w-value text-center"><span id="load-kW">{{gensetData['Power']}}</span> kW </p>#}
                                </div>
                                <div class="widget-content">    
                                    <div class="w-chart">
                                        <div id="w-load-chart"></div>
                                    </div>

                                    <div class="row ml-2 mt-2" style="font-size:12px">
                                        <div class="col">Consommation</div>
                                        <div class="col"><span id="w-load-conso">{{loadSiteData['totalKWh']}}</span> kWh</div>
                                    </div>
                                    <div class="row ml-2" style="font-size:12px">
                                        <div class="col">FP</div>
                                        <div class="col"><span id="w-load-fp">{{loadSiteData['FP']}}</span></div>
                                    </div>
                                    <div class="row ml-2 mb-2" style="font-size:12px">
                                        <div class="col">Pmax</div>
                                        <div class="col"><span id="w-load-pmax">{{loadSiteData['Pmax']}}</span> kW</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col">
                            <div class="row layout-top-spacing ">
                            
                                <div class="widget widget-one_hybrid widget-solar-site" style="z-index: 2;">
                                    <div class="widget-heading">
                                        <div class="w-icon source-name">
                                            <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="solar-panel" class="svg-inline--fa fa-solar-panel fa-w-20" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M431.98 448.01l-47.97.05V416h-128v32.21l-47.98.05c-8.82.01-15.97 7.16-15.98 15.99l-.05 31.73c-.01 8.85 7.17 16.03 16.02 16.02l223.96-.26c8.82-.01 15.97-7.16 15.98-15.98l.04-31.73c.01-8.85-7.17-16.03-16.02-16.02zM585.2 26.74C582.58 11.31 568.99 0 553.06 0H86.93C71 0 57.41 11.31 54.79 26.74-3.32 369.16.04 348.08.03 352c-.03 17.32 14.29 32 32.6 32h574.74c18.23 0 32.51-14.56 32.59-31.79.02-4.08 3.35 16.95-54.76-325.47zM259.83 64h120.33l9.77 96H250.06l9.77-96zm-75.17 256H71.09L90.1 208h105.97l-11.41 112zm16.29-160H98.24l16.29-96h96.19l-9.77 96zm32.82 160l11.4-112h149.65l11.4 112H233.77zm195.5-256h96.19l16.29 96H439.04l-9.77-96zm26.06 256l-11.4-112H549.9l19.01 112H455.33z"></path></svg>
                                        </div>
                                        <div class="source-name">DC Input</div>
{#                                        <p class="w-value text-center"><span id="dcInput-kW">-</span> </p>#}
                                    </div>
                                    <div class="widget-content">    
                                        <div class="w-chart">
                                            <div id="w-load-chart-dcInput"></div>
                                        </div>

                                        <div class="row ml-2 mt-2" style="font-size:12px">
                                            <div class="col">Fourniture</div>
                                            {# <div class="col"><span id="w-solar-fourniture">17</span> kWh</div> #}
                                            <div class="col"><span id="w-dcInput-fourniture">{{dcInputData['totalKWh']}}</span> kWh</div> {# gridData['totalKWh'] #}
                                        </div>
                                        <div class="row ml-2" style="font-size:12px">
                                            <div class="col">Contribution</div>
                                            {# <div class="col"><span id="w-solar-contri">5</span> %</div> #}
                                            <div class="col"><span id="w-dcInput-contrib">{{dcInputData['contrib']}}</span> %</div>{# gridData['contrib'] #}
                                        </div>

                                        <div class="row ml-2 mb-2" style="font-size:12px">
                                            <div class="col">Pmax</div>
                                            {# <div class="col"><span id="w-solar-pmax">12</span> kW</div> #}
                                            <div class="col"><span id="w-dcInput-pmax">{{dcInputData['Pmax']}}</span> kW</div>{# gridData['Pmax'] #}
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            
                            <div class="row layout-top-spacing">
                                
                                <div class="widget widget-one_hybrid widget-followers" style="width:230px;background-color:#fff;z-index: 2;">
                                    <div class="widget-heading">
                                        <div class="w-icon source-name">
                                            <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="car-battery" class="svg-inline--fa fa-car-battery fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M480 128h-32V80c0-8.84-7.16-16-16-16h-96c-8.84 0-16 7.16-16 16v48H192V80c0-8.84-7.16-16-16-16H80c-8.84 0-16 7.16-16 16v48H32c-17.67 0-32 14.33-32 32v256c0 17.67 14.33 32 32 32h448c17.67 0 32-14.33 32-32V160c0-17.67-14.33-32-32-32zM192 264c0 4.42-3.58 8-8 8H72c-4.42 0-8-3.58-8-8v-16c0-4.42 3.58-8 8-8h112c4.42 0 8 3.58 8 8v16zm256 0c0 4.42-3.58 8-8 8h-40v40c0 4.42-3.58 8-8 8h-16c-4.42 0-8-3.58-8-8v-40h-40c-4.42 0-8-3.58-8-8v-16c0-4.42 3.58-8 8-8h40v-40c0-4.42 3.58-8 8-8h16c4.42 0 8 3.58 8 8v40h40c4.42 0 8 3.58 8 8v16z"></path></svg>
                                        </div>
                                        <div class="source-name">Battérie</div>
                                        <p class="w-value text-center"><span id="w-batt-volt">{{dcData['BattVolt']}}</span> V</p>
                                        
                                    </div>
                                    <div class="widget-content">    
                                        <div class="w-chart">
                                            <div id="w-volt-chart-batt"></div>
                                        </div>

                                        <div class="row ml-2 mt-2" style="font-size:12px">
                                            <div class="col">Disponibilité : </div>
                                            <div class="col"><span id="w-batt-dispo">{{ dcData['BattEnergy'] }}</span> kWh</div> {#  #}
                                            <!-- <div class="col">-</div> -->
                                        </div>
                                        {#<div class="row ml-2" style="font-size:12px">
                                            <div class="col">Fourniture : </div>
                                            <div class="col"><span id="w-batt-fourniture">{{ 15 }}</span> kWh</div>
                                            <!-- <div class="col">-</div> -->
                                        </div>
                                        <div class="row ml-2" style="font-size:12px">
                                            <div class="col">Appro : </div>
                                            <div class="col"><span id="w-batt-appro">2</span> %</div>
                                            <!-- <div class="col">-</div> -->
                                        </div>#}
                                        <div class="row ml-2 mb-2" style="font-size:12px">
                                            <div class="col">État : </div>
                                            <!-- <div class="col"><span id="w-batt-niv-charge">85</span>% @ <span id="w-batt-volt">12.5</span>V</div> -->
                                            <div class="col text-{% if dcData['BattState'] %}success{% else %}danger{% endif %}" id="w-batt-state">{% if dcData['BattState'] %}Charge{% else %}Décharge{% endif %}</div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
                
                
            </div>

            <div class="col-xl-3 col-lg-3 col-md-3 col-sm-3 col-12 layout-top-spacing ">
                <div class="row">
                    <div class="col-12 layout-spacing">
                        <div class="widget widget-one_hybrid widget-followers">
                            <div class="widget-heading">
                                <div class="w-icon source-name">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                </div>
                                <div class="source-name mx-5" id="icon"><img id="wicon" src="" alt="Weather icon"></div>
                                <p class="w-value text-center"><span id="w-temp">-</span> °C | <span id="w-hum">-</span> %rH
                                {# <h5 class="">Consommation du mois en cours</h5> #}
                            </div>
                            <div class="widget-content">    
                                <div class="w-chart">
                                    <div id="w-map-pin"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 layout-spacing">
                        <div class="widget widget-one_hybrid widget-referral">
                            <div class="widget-heading">
                                <div class="w-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-cloud"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
                                </div>
                                <p class="w-value"><span id="w-emission-value">{{kgCO2}}</span> kgCO<sub>2</sub></p>
                                <h5 class="">Empreinte Carbone du mois</h5>
                            </div>
                            <div class="widget-content mt-2">    
                                <div class="w-chart">
                                    <div id="w-co2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>

        </div>
        
        <div class="statbox widget box layout-spacing layout-top-spacing ">
            <div class="widget-header">                                 
                <div class="row">
                    <div class="col-xl-12 col-md-12 col-sm-12 col-12 d-inline-block">
                        <h5>Historique de données</h5> 
                        <h6 class="float-right"><a href="{{ path('historical_analytic_site_pro_dc_show', {'slug':site.slug}) }}">Allez plus loin</a></h6>
                    </div>
                </div>
            </div>
            <div class="widget-content widget-content-area">
                {# <p>Date time picker is powered by <span class="text-primary">flatpickr.js</span> that gives the ability to user to select date or time.</p> #}
                <div class="form-group mb-0">
                    <input id="daterange" value="2020-10-07" class="form-control flatpickr flatpickr-input active" type="text" placeholder="Select Date..">
                </div>
            </div>
        </div>
        <div class="row widget-statistic layout-top-spacing">
            <div class="col-xl-9 col-lg-9 col-md-9 col-sm-9 col-12 layout-spacing" >
                <div class="widget widget-chart-three layout-spacing layout-top-spacing">
                    <div class="widget-heading">
                        <div class="">
                            <h5 class="">Diagramme de Consommation</h5>
                        </div>

                        <!-- <div class="dropdown  custom-dropdown">
                            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink-1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                            </a>

                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink-1">
                                <a class="dropdown-item" href="javascript:void(0);">View</a>
                                <a class="dropdown-item" href="javascript:void(0);">Update</a>
                                <a class="dropdown-item" href="javascript:void(0);">Download</a>
                            </div>
                        </div> -->
                    </div>

                    <div class="widget-content">
                        <div id="conso"></div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-3 col-md-3 col-sm-3 col-12 layout-spacing" >
                <div class="widget widget-chart-three layout-spacing layout-top-spacing">
                    <div class="widget-heading">
                        <div class="">
                            <h5 class="">Conso du site : <span id="total-conso">0</span> kWh</h5>
                        </div>

                        <!-- <div class="dropdown  custom-dropdown">
                            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink-1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                            </a>

                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink-1">
                                <a class="dropdown-item" href="javascript:void(0);">View</a>
                                <a class="dropdown-item" href="javascript:void(0);">Update</a>
                                <a class="dropdown-item" href="javascript:void(0);">Download</a>
                            </div>
                        </div> -->
                    </div>

                    <div class="widget-content">
                        <div class="text-center h6 my-2 text-dark">Contribution des Sources</div>
                        <div id="contri-source"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
{# BEGIN PAGE LEVEL PLUGINS/CUSTOM SCRIPTS #}
<script src="/js/scrollspyNav.js"></script>
<script src="/plugins/sweetalerts/sweetalert2.min.js"></script>
<script src="/plugins/sweetalerts/custom-sweetalert.js"></script>
<script src="/plugins/apex/apexcharts.min.js"></script>
<script src="/js/widgets/modules-widgets.js"></script>

<script src="/plugins/moment/moment.js"></script>
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script> #}
<script src="/plugins/daterangepicker/daterangepicker.js"></script>
<script src="/plugins/sweet-alert2/sweetalert2.min.js"></script>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>

<!-- Chart JS -->
<script src="/plugins/chartjs/chart.min.js"></script>
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js" integrity="sha512-Wt1bJGtlnMtGP0dqNFH1xlkLBNpEodaiQ8ZN5JLA5wpc1sUlk/O5uuOMNgvzddzkpvZ9GLyYNa8w2s7rqiTk5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> #}

<script src="/plugins/justgage/justgage.js"></script>
<script src="/plugins/justgage/raphael-2.1.4.min.js"></script>
        

<script src="/plugins/highlight/highlight.pack.js"></script>
{# BEGIN PAGE LEVEL PLUGINS/CUSTOM SCRIPTS #}
{# <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.4/js/dataTables.buttons.min.js"></script> #}
<script src="/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/plugins/datatables/dataTables.buttons.min.js"></script>
{# <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script> #}
<script src="/plugins/datatables/dataTables.bootstrap4.min.js"></script>
<script src="/plugins/datatables/buttons.bootstrap4.min.js"></script>

<script src="/plugins/datatables/jszip.min.js"></script>
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script> #}

{# <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.print.min.js"></script> #}
<script src="/plugins/datatables/pdfmake.min.js"></script>
<script src="/plugins/datatables/vfs_fonts.js"></script>
<script src="/plugins/datatables/buttons.html5.min.js"></script>
<script src="/plugins/datatables/buttons.print.min.js"></script>

{# <script src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.colVis.min.js"></script> #}
<!-- Responsive examples -->
{# <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script> #}
{# <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script> #}

{# Overview tab panel scripts #}

<script>

    // Where you want to render the map.
    var element = document.getElementById('w-map-pin');

    // Height has to be set. You can do this in CSS too.
    element.style = 'height:300px;';

    var map = L.map('w-map-pin').setView([{{site.latitude}}, {{site.longitude}}], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    L.marker([{{site.latitude}}, {{site.longitude}}]).addTo(map)
        .bindPopup('{{site.name}}.<br><span style="text-align: center">lat:{{site.latitude}}, long:{{site.longitude}}</span>')
        .openPopup();
</script> 

<script>
    var now = new Date();
    //var jsDate = now.getDate()+'-'+(now.getMonth()+1)+'-'+now.getFullYear();
    var FileNameGridBill = 'Récap Grid | ' + now.getFullYear();
    var historicGridBillTable = $('#historic-gridBill-dataTable').DataTable({
        //lengthChange: false,
        //buttons: ['copy', 'excel', 'pdf', 'colvis']
        //buttons: ['excel', 'pdf'],
        searching: false, 
        paging: false, 
        info: false,
        order: [],
        ordering: false,
        lengthChange: false,
        //buttons: ['copy', 'excel', 'pdf', 'colvis']
        buttons: [
            {
                //text: 'Exporter Disponibilité',
                extend: 'pdfHtml5',
                filename: 'Récap Grid - ' + now.getFullYear(),//function () { return getExportFileName();},//
                exportOptions: {
                    //columns: [ 0, 1, 4 ],
                    //columns: ':visible'
                    search: 'applied',
                    order: 'applied'
                },
                title: function( thead, data, start, end, display ) {
                    return "{{site.name}}\r\n" + FileNameGridBill;
                },
                customize: function (doc) {
                    //Remove the title created by datatTables
                    
                    //Create a date string that we use in the footer. Format is dd-mm-yyyy
                    var now = new Date();
                    var jsDate = now.getDate()+'-'+(now.getMonth()+1)+'-'+now.getFullYear();
                    // Logo converted to base64
                    // var logo = getBase64FromImageUrl('https://datatables.net/media/images/logo.png');
                    // The above call should work, but not when called from codepen.io
                    // So we use a online converter and paste the string in.
                    // Done on http://codebeautify.org/image-to-base64-converter
                    // It's a LONG string scroll down to see the rest of the code !!!
                    //var logo = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAICAgICAQICAgIDAgIDAwYEAwMDAwcFBQQGCAcJCAgHCAgJCg0LCQoMCggICw8LDA0ODg8OCQsQERAOEQ0ODg7/2wBDAQIDAwMDAwcEBAcOCQgJDg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg7/wAARCAAwADADASIAAhEBAxEB/8QAGgAAAwEAAwAAAAAAAAAAAAAABwgJBgIFCv/EADUQAAEDAgQDBgUDBAMAAAAAAAECAwQFBgAHESEIEjEJEyJBUXEUI0JhgRVSYhYXMpEzcrH/xAAYAQADAQEAAAAAAAAAAAAAAAAEBQYHAv/EAC4RAAEDAgMGBQQDAAAAAAAAAAECAxEABAUGEhMhMUFRcSIyYaHBFkKB0ZGx8P/aAAwDAQACEQMRAD8Avy44hlhTrqw22kEqUo6BIG5JPkMSxz67RlFPzFquWnDParOaN4QVlmqXDKcKKLS19CCsf8qh6A6e+OfaK573LDTanDJllVV0q8r3ZVIuGqR1fMpdJSdHCCOinN0j7e+FjymydjRKdSbGsikpbSlG5O3/AHfeX5nU6knck6DFdg+DovkquLlWllHE8yeg+f4FBPvluEpEqNC657/4yr4ecm3ZxH1OghzxfptpQERI7X8QrqdPXGNpucXGLltU0SbZ4jazW0tHX4C6IiJcd37HUEj8YoHNtTKOzwuHVPj79rTfhkfCudxEbUOqQQd9Pc4HlaoGRt2JVAcptRsOe54WZZkd6yFHpzakgD3098ahYWuVVDQ/YrKD9wJnvGqfb8UAHH584npWw4eu0+iVO+6Vl3xO2zHy1uKa4GafdcBwqos5w7AOE6lgk+epT68uK8MvNPxmnmHEvMuJCm3EKCkqSRqCCNiCPPHmbzdyWcozkq1rpitVSkzGyqHNbT4HU+S0H6Vp22/9Bw8XZkcQ1wuzLg4V8yqq5U69a0X42zalJXq5NpeuhZJO5LWo0/idPpxI5ryszgyG77D3Nrau+U8weh/cDgQRI3sGXi54VCCKXK6Ku5fnbOcTt2znO/8A0SfFtymcx17llpGqgPTUjDj5WOIOUmYFPpLgjXQ5ES627r43I6R40I9D16fuGEfzPZeyq7afiRtec0W03O/GuSj82wdbdb8ZB89FEjb0xvrIzGk2pmnSrgcdUttl3lkoB2UyrZadPbf8DFFhGHuX+W0bASUyY6kKJg96XPK0XJmt9MrkFuIQw2XNup8IwFbruVaWXkttMgadCCcEfNuPTbbzPkiK87+jVRsTqctlIKVNubkD2J/0RgBVFDVQUpTTEksjdTjpG4xc4TYOvBu5AhB3yf8AcfmgTIUUmiMxcs27+CG42Koy3JqFqym3YLytebuVfRr9gVD2AwvOWt5u2f2qXDle0FK4UhVwijzgFbPMSUlBSftqdcMAqN/TfCVV0yGBDl3O+huMwvZXw6Oqzr67n8jC85VWw/fnakZD2tAaL/wtwGsSuTfu2YyCeY+6ikY5x1yzVlDECB4C8Nn3lEx6SFe9MWtW3R1jfVTu0l4a7lv6wbaz8yqp6p2gridZ2X6FmXT2U6uVelq8TrQA3UtG6gPMFQG+mJe2Xf8ASL5s1qp0p35qfDLhuHR2M4P8kLT5aH/ePUSpIUnQjUemJh8SXZs2fmVf8/MvJevKyfzNkEuTPhGeamVNZ3JeZGnKonqpPXqQTjE8tZmdwF4hSdbSjvHMHqP1zo24tw8J4EUn9MvWz7iymo9tX27PgTqQ4tMCfGY735SuiFdenTTTyGOIrGV1DSJLCqndb7Z1aamIDEZJHQqGg5vyDga3Fw28bVhS1wqrlHAzAjtkhFSt2sIQHR5HkXoQftjrqJw5cYt81BESDkuxaCVnRU24K0Fpb+/I3qT7Y1b6kygptSi88lKiSWxIEkyRygE8tUUDsbieA71mM2M0mZxlVytTQ0w0jkQlIIQ2PpabR1JJ6Abk4oP2bHDhW6O9WuITMKlLplxV9hMeg06Sn5lPgjdIUPJayedX4HljvOHvs16VbF7Uy/c86/8A3DuyIoOwoAaDdPgL66ts7gqH7lan2xVaJEjQaezFiMIjx2khLbaBoEgYyzMmZTjWi2t0bK3b8qfk+v8AW/jNMGWdn4lGVGv/2SAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=';
                    // A documentation reference can be found at
                    // https://github.com/bpampuch/pdfmake#getting-started
                    // Set page margins [left,top,right,bottom] or [horizontal,vertical]
                    // or one number for equal spread
                    // It's important to create enough space at the top for a header !!!
                    doc.pageMargins = [60,60,60,30];
                    // Set the font size fot the entire document
                    doc.defaultStyle.fontSize = 12;
                    // Set the fontsize for the table header
                    doc.styles.tableHeader.fontSize = 13;
                    //doc.styles.tableBodyOdd.fillColor = "yellow";
                    {# doc.styles.tableBodyOdd.alignment = function (rowIndex, node, columnIndex) {
                                                    //return (rowIndex >= 0) ? 'center' : null;
                                                    return 'center';
                                                }; #}
                    doc.styles.tableBodyEven.alignment = 'center';
                    doc.styles.tableBodyOdd.alignment = 'center'; 
                    {# doc.styles.tableHeader.fillColor = "#6c757d"; #}
                    console.log(doc);
                    var objTable = {};
                    //objTable['heights'] = (function(i) { return 100; });
                    //objTable['widths'] = ['*', 'auto', '*', 'auto', 'auto', 'auto'];
                    //objTable['widths']   = (function(i) { return ['*', 'auto', '*', 'auto', 'auto', 'auto']; });
                    //doc.content[1].table = objTable; 
                    doc.content[1].table.widths = ['auto', '*', 'auto', '*']; 
                    //doc.content[1].table.heights = (function(i) { return 100; }); 
                    {# doc.content[1].layout = {
                                                fillColor: function (rowIndex, node, columnIndex) {
                                                    return (rowIndex % 2 === 0) ? '#CCCCCC' : null;
                                                }
                                            };  #}
                        
                    // Create a header object with 3 columns
                    // Left side: Logo
                    // Middle: brandname
                    // Right side: A document title
                    /*doc['header']=(function() {
                        return {
                            columns: [
                                {
                                    //image: logo,
                                    "width": 24
                                },
                                {
                                    alignment: 'left',
                                    italics: true,
                                    text: 'dataTables',
                                    fontSize: 18,
                                    margin: [10,0]
                                },
                                {
                                    alignment: 'right',
                                    fontSize: 14,
                                    text: 'Custom PDF export with dataTables'
                                }
                            ],
                            margin: 20
                        }
                    });*/
                    // Create a footer object with 2 columns
                    // Left side: report creation date
                    // Right side: current page and total pages
                    doc['footer']=(function(page, pages) {
                        return {
                            columns: [
                                {
                                    alignment: 'left',
                                    text: ['Crée le : ', { text: jsDate.toString() }]
                                },
                                {
                                    alignment: 'center',
                                    text: ['{{app.user.enterprise.socialReason}} {% if app.user.enterprise.niu is not empty %}- NIU : {{app.user.enterprise.niu}} {% endif %} {% if app.user.enterprise.rccm is not empty %}- RCCM : {{app.user.enterprise.rccm}}{% endif %}']
                                },
                                {
                                    alignment: 'right',
                                    text: ['page ', { text: page.toString() },	'/',	{ text: pages.toString() }]
                                }
                            ],
                            margin: [10, 0]
                        }
                    });
                    console.log(doc['footer'])
                    // Change dataTable layout (Table styling)
                    // To use predefined layouts uncomment the line below and comment the custom lines below
                    // doc.content[0].layout = 'lightHorizontalLines'; // noBorders , headerLineOnly
                    var objLayout = {};
                    objLayout['hLineWidth']   = (function(i) { return .5; });
                    objLayout['vLineWidth']   = (function(i) { return .5; });
                    objLayout['hLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['vLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['paddingLeft']  = (function(i) { return 4; });
                    objLayout['paddingRight'] = (function(i) { return 4; });
                    doc.content[0].layout = objLayout;
                } 
            },
            {
                //text: 'Exporter Disponibilité',
                extend: 'excel',
                filename: FileNameGridBill,
                exportOptions: {
                    //columns: [ 0, 1, 4 ],
                    //columns: ':visible'
                    search: 'applied',
                    order: 'applied'
                },
            }
        ] 
    });

    historicGridBillTable.buttons().container().appendTo('#historic-gridBill-dataTable_wrapper .col-md-6:eq(0)');
    
    var FileNameFuelBill = 'Récap Fuel | ' + now.getFullYear();
    var historicFuelBillTable = $('#historic-fuelBill-dataTable').DataTable({
        //lengthChange: false,
        //buttons: ['copy', 'excel', 'pdf', 'colvis']
        //buttons: ['excel', 'pdf'],
        searching: false, 
        paging: false, 
        info: false,
        order: [],
        ordering: false,
        lengthChange: false,
        //buttons: ['copy', 'excel', 'pdf', 'colvis']
        buttons: [
            {
                //text: 'Exporter Disponibilité',
                extend: 'pdfHtml5',
                filename: 'Récap Fuel - ' + now.getFullYear(),//function () { return getExportFileName();},//
                exportOptions: {
                    //columns: [ 0, 1, 4 ],
                    //columns: ':visible'
                    search: 'applied',
                    order: 'applied'
                },
                title: function( thead, data, start, end, display ) {
                    return "{{site.name}}\r\n" + FileNameGridBill;
                },
                customize: function (doc) {
                    //Remove the title created by datatTables
                    
                    //Create a date string that we use in the footer. Format is dd-mm-yyyy
                    var now = new Date();
                    var jsDate = now.getDate()+'-'+(now.getMonth()+1)+'-'+now.getFullYear();
                    // Logo converted to base64
                    // var logo = getBase64FromImageUrl('https://datatables.net/media/images/logo.png');
                    // The above call should work, but not when called from codepen.io
                    // So we use a online converter and paste the string in.
                    // Done on http://codebeautify.org/image-to-base64-converter
                    // It's a LONG string scroll down to see the rest of the code !!!
                    //var logo = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAICAgICAQICAgIDAgIDAwYEAwMDAwcFBQQGCAcJCAgHCAgJCg0LCQoMCggICw8LDA0ODg8OCQsQERAOEQ0ODg7/2wBDAQIDAwMDAwcEBAcOCQgJDg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg7/wAARCAAwADADASIAAhEBAxEB/8QAGgAAAwEAAwAAAAAAAAAAAAAABwgJBgIFCv/EADUQAAEDAgQDBgUDBAMAAAAAAAECAwQFBgAHESEIEjEJEyJBUXEUI0JhgRVSYhYXMpEzcrH/xAAYAQADAQEAAAAAAAAAAAAAAAAEBQYHAv/EAC4RAAEDAgMGBQQDAAAAAAAAAAECAxEABAUGEhMhMUFRcSIyYaHBFkKB0ZGx8P/aAAwDAQACEQMRAD8Avy44hlhTrqw22kEqUo6BIG5JPkMSxz67RlFPzFquWnDParOaN4QVlmqXDKcKKLS19CCsf8qh6A6e+OfaK573LDTanDJllVV0q8r3ZVIuGqR1fMpdJSdHCCOinN0j7e+FjymydjRKdSbGsikpbSlG5O3/AHfeX5nU6knck6DFdg+DovkquLlWllHE8yeg+f4FBPvluEpEqNC657/4yr4ecm3ZxH1OghzxfptpQERI7X8QrqdPXGNpucXGLltU0SbZ4jazW0tHX4C6IiJcd37HUEj8YoHNtTKOzwuHVPj79rTfhkfCudxEbUOqQQd9Pc4HlaoGRt2JVAcptRsOe54WZZkd6yFHpzakgD3098ahYWuVVDQ/YrKD9wJnvGqfb8UAHH584npWw4eu0+iVO+6Vl3xO2zHy1uKa4GafdcBwqos5w7AOE6lgk+epT68uK8MvNPxmnmHEvMuJCm3EKCkqSRqCCNiCPPHmbzdyWcozkq1rpitVSkzGyqHNbT4HU+S0H6Vp22/9Bw8XZkcQ1wuzLg4V8yqq5U69a0X42zalJXq5NpeuhZJO5LWo0/idPpxI5ryszgyG77D3Nrau+U8weh/cDgQRI3sGXi54VCCKXK6Ku5fnbOcTt2znO/8A0SfFtymcx17llpGqgPTUjDj5WOIOUmYFPpLgjXQ5ES627r43I6R40I9D16fuGEfzPZeyq7afiRtec0W03O/GuSj82wdbdb8ZB89FEjb0xvrIzGk2pmnSrgcdUttl3lkoB2UyrZadPbf8DFFhGHuX+W0bASUyY6kKJg96XPK0XJmt9MrkFuIQw2XNup8IwFbruVaWXkttMgadCCcEfNuPTbbzPkiK87+jVRsTqctlIKVNubkD2J/0RgBVFDVQUpTTEksjdTjpG4xc4TYOvBu5AhB3yf8AcfmgTIUUmiMxcs27+CG42Koy3JqFqym3YLytebuVfRr9gVD2AwvOWt5u2f2qXDle0FK4UhVwijzgFbPMSUlBSftqdcMAqN/TfCVV0yGBDl3O+huMwvZXw6Oqzr67n8jC85VWw/fnakZD2tAaL/wtwGsSuTfu2YyCeY+6ikY5x1yzVlDECB4C8Nn3lEx6SFe9MWtW3R1jfVTu0l4a7lv6wbaz8yqp6p2gridZ2X6FmXT2U6uVelq8TrQA3UtG6gPMFQG+mJe2Xf8ASL5s1qp0p35qfDLhuHR2M4P8kLT5aH/ePUSpIUnQjUemJh8SXZs2fmVf8/MvJevKyfzNkEuTPhGeamVNZ3JeZGnKonqpPXqQTjE8tZmdwF4hSdbSjvHMHqP1zo24tw8J4EUn9MvWz7iymo9tX27PgTqQ4tMCfGY735SuiFdenTTTyGOIrGV1DSJLCqndb7Z1aamIDEZJHQqGg5vyDga3Fw28bVhS1wqrlHAzAjtkhFSt2sIQHR5HkXoQftjrqJw5cYt81BESDkuxaCVnRU24K0Fpb+/I3qT7Y1b6kygptSi88lKiSWxIEkyRygE8tUUDsbieA71mM2M0mZxlVytTQ0w0jkQlIIQ2PpabR1JJ6Abk4oP2bHDhW6O9WuITMKlLplxV9hMeg06Sn5lPgjdIUPJayedX4HljvOHvs16VbF7Uy/c86/8A3DuyIoOwoAaDdPgL66ts7gqH7lan2xVaJEjQaezFiMIjx2khLbaBoEgYyzMmZTjWi2t0bK3b8qfk+v8AW/jNMGWdn4lGVGv/2SAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=';
                    // A documentation reference can be found at
                    // https://github.com/bpampuch/pdfmake#getting-started
                    // Set page margins [left,top,right,bottom] or [horizontal,vertical]
                    // or one number for equal spread
                    // It's important to create enough space at the top for a header !!!
                    doc.pageMargins = [60,60,60,30];
                    // Set the font size fot the entire document
                    doc.defaultStyle.fontSize = 12;
                    // Set the fontsize for the table header
                    doc.styles.tableHeader.fontSize = 13;
                    //doc.styles.tableBodyOdd.fillColor = "yellow";
                    {# doc.styles.tableBodyOdd.alignment = function (rowIndex, node, columnIndex) {
                                                    //return (rowIndex >= 0) ? 'center' : null;
                                                    return 'center';
                                                }; #}
                    doc.styles.tableBodyEven.alignment = 'center';
                    doc.styles.tableBodyOdd.alignment = 'center'; 
                    {# doc.styles.tableHeader.fillColor = "#6c757d"; #}
                    console.log(doc);
                    var objTable = {};
                    //objTable['heights'] = (function(i) { return 100; });
                    //objTable['widths'] = ['*', 'auto', '*', 'auto', 'auto', 'auto'];
                    //objTable['widths']   = (function(i) { return ['*', 'auto', '*', 'auto', 'auto', 'auto']; });
                    //doc.content[1].table = objTable; 
                    doc.content[1].table.widths = ['auto', '*']; 
                    //doc.content[1].table.heights = (function(i) { return 100; }); 
                    {# doc.content[1].layout = {
                                                fillColor: function (rowIndex, node, columnIndex) {
                                                    return (rowIndex % 2 === 0) ? '#CCCCCC' : null;
                                                }
                                            };  #}
                        
                    // Create a header object with 3 columns
                    // Left side: Logo
                    // Middle: brandname
                    // Right side: A document title
                    /*doc['header']=(function() {
                        return {
                            columns: [
                                {
                                    //image: logo,
                                    "width": 24
                                },
                                {
                                    alignment: 'left',
                                    italics: true,
                                    text: 'dataTables',
                                    fontSize: 18,
                                    margin: [10,0]
                                },
                                {
                                    alignment: 'right',
                                    fontSize: 14,
                                    text: 'Custom PDF export with dataTables'
                                }
                            ],
                            margin: 20
                        }
                    });*/
                    // Create a footer object with 2 columns
                    // Left side: report creation date
                    // Right side: current page and total pages
                    doc['footer']=(function(page, pages) {
                        return {
                            columns: [
                                {
                                    alignment: 'left',
                                    text: ['Crée le : ', { text: jsDate.toString() }]
                                },
                                {
                                    alignment: 'center',
                                    text: ['{{app.user.enterprise.socialReason}} {% if app.user.enterprise.niu is not empty %}- NIU : {{app.user.enterprise.niu}} {% endif %} {% if app.user.enterprise.rccm is not empty %}- RCCM : {{app.user.enterprise.rccm}}{% endif %}']
                                },
                                {
                                    alignment: 'right',
                                    text: ['page ', { text: page.toString() },	' de ',	{ text: pages.toString() }]
                                }
                            ],
                            margin: [10, 0]
                        }
                    });
                    // Change dataTable layout (Table styling)
                    // To use predefined layouts uncomment the line below and comment the custom lines below
                    // doc.content[0].layout = 'lightHorizontalLines'; // noBorders , headerLineOnly
                    var objLayout = {};
                    objLayout['hLineWidth']   = (function(i) { return .5; });
                    objLayout['vLineWidth']   = (function(i) { return .5; });
                    objLayout['hLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['vLineColor']   = (function(i) { return '#ccc'; });
                    objLayout['paddingLeft']  = (function(i) { return 4; });
                    objLayout['paddingRight'] = (function(i) { return 4; });
                    doc.content[0].layout = objLayout;
                } 
            },
            {
                //text: 'Exporter Disponibilité',
                extend: 'excel',
                filename: FileNameGridBill,
                exportOptions: {
                    //columns: [ 0, 1, 4 ],
                    //columns: ':visible'
                    search: 'applied',
                    order: 'applied'
                },
            }
        ] 
    });

    historicFuelBillTable.buttons().container().appendTo('#historic-fuelBill-dataTable_wrapper .col-md-6:eq(0)');

    $('.buttons-pdf').children('span').prepend('<i class="mdi mdi-download mr-2"></i>');
    $('.buttons-pdf').removeClass('btn-secondary').addClass('btn-outline-danger')
    $('.buttons-excel').removeClass('btn-secondary').addClass('btn-outline-success')
</script>

<script>

    // w-load Chart Grid variable
    var w_loadChartGrid;

    // w-load Chart Genset variable
    var w_loadChartGenset;

    // w-load Chart DC Input variable
    var w_loadChartDCInput;

    // w-load Chart Batt variable
    var w_voltageProfileBatt;

    // w-co2 Chart variable
    var w_co2Chart;

    // w-loadChart Chart variable
    var w_loadChart;
    
    // load Chart variable
    var loadChart;
    //const promise = function(){
    new Promise(function(resolve, reject){
        //$('#load-chart-loader').removeClass('d-none')
        setTimeout(function(){
            /*var defs1 = {
                label: "label",
                value: 65,
                min: 0,
                max: 100,
                decimals: 0,
                gaugeWidthScale: 0.6,
                pointer: true,
                pointerOptions: {
                    toplength: 10,
                    bottomlength: 10,
                    bottomwidth: 2
                },
                counter: true
            }

            var jg2 = new JustGage({
                id: "fuel_level",
                defaults: defs1
            });*/
            
            var loadGrid_options = {
                chart: {
                    id: 'kW_Grid',
                    group: 'loadChart',
                    type: 'area',
                    height: 30,
                    sparkline: {
                        enabled: true
                    },
                    animations:{
                        enabled:false
                    },
                },
                stroke: {
                    curve: 'smooth',
                    width: 2,
                },
                series: [{
                    {# name: 'Énergie Active', #}
                    name: 'Puissance Active',
                    {# data: {{ gridData['kWh'] | json_encode | raw }} #}
                    data: {{ gridData['kW'] | json_encode | raw }}
                    {# data: [28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 27, 51, 80] #}
                }],
                {# labels: {{ gridData['date'] | json_encode | raw }}, #}
                labels: {{ gridData['dateP'] | json_encode | raw }},
                {# labels: ['1', '2', '3', '4', '5', '6', '7'], #}
                xaxis: {
                    type: 'datetime',
                    //categories: [2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016],
                    {# categories: {{ gridData['dateP'] | json_encode | raw }}, #}
                    categories: [],
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM \'yy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        text: moment().format('MMM YYYY').toString(),
                        style: {
                            fontSize: '14px',
                            fontWeight: 'bold',
                            fontFamily: undefined,
                            color: '#444'
                        },
                    }
                },
                yaxis: {
                    min: 0
                },
                colors: ['#53e21b'],
                tooltip: {
                    theme: "dark",
                    //followCursor: true,
                    y: {
                        formatter: function (y) {
                            //console.log(y)
                            if (typeof y !== "undefined") {
                                {# return y.toFixed(2) + " kWh" #}
                                return y.toFixed(2) + " kW"
                            }
                            return y;
                        }
                    },
                    x: {
                        formatter: function (val, timestamp) {
                            return moment(new Date(val)).format("DD MMM YYYY HH:mm")
                        }
                    }
                },
                /*tooltip: {
                    x: {
                    show: false,
                    }
                },*/
                fill: {
                    type:"gradient",
                    gradient: {
                        type: "vertical",
                        shadeIntensity: 1,
                        inverseColors: !1,
                        opacityFrom: .40,
                        opacityTo: .05,
                        stops: [45, 100]
                    }
                },
                noData: {
                    text: 'Data not yet available',
                    align: 'center',
                    verticalAlign: 'middle',
                    offsetX: 0,
                    offsetY: 0,
                    style: {
                        color: undefined,
                        fontSize: '10px',
                        fontFamily: 'Nunito, sans-serif'
                    }
                }
            }
            // w-conso Chart variable
            w_loadChartGrid = new ApexCharts(document.querySelector("#w-load-chart-grid"), loadGrid_options);
            w_loadChartGrid.render()


            var loadGenset_options = {
                chart: {
                    id: 'kW_Genset',
                    group: 'loadChart',
                    type: 'area',
                    height: 30,
                    sparkline: {
                        enabled: true
                    },
                    animations:{
                        enabled:false
                    },
                },
                stroke: {
                    curve: 'smooth',
                    width: 2,
                },
                series: [{
                    {# name: 'Énergie Active', #}
                    name: 'Puissance Active',
                    {# data: {% if hasgensetMod %}{{ gensetData['dayBydayTEPData']['TEP'] | json_encode | raw }}{% else %}[]{% endif %} #}
                    data: {% if hasgensetMod %}{{ gensetData['loadProfileData']['kW'] | json_encode | raw }}{% else %}[]{% endif %}
                    {# data: [28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 27, 51, 80] #}
                }],
                {# labels: {% if hasgensetMod %}{{ gensetData['dayBydayTEPData']['date'] | json_encode | raw }}{% else %}[]{% endif %}, #}
                labels: {% if hasgensetMod %}{{ gensetData['loadProfileData']['date'] | json_encode | raw }}{% else %}[]{% endif %},
                {# labels: ['1', '2', '3', '4', '5', '6', '7'], #}
                xaxis: {
                    type: 'datetime',
                    //categories: [2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016],
                    categories: [],
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM \'yy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        text: moment().format('MMM YYYY').toString(),
                        style: {
                            fontSize: '14px',
                            fontWeight: 'bold',
                            fontFamily: undefined,
                            color: '#444'
                        },
                    }
                },
                yaxis: {
                    min: 0
                },
                colors: ['#e26b1b'],
                tooltip: {
                    theme: "dark",
                    //followCursor: true,
                    y: {
                        formatter: function (y) {
                            //console.log(y)
                            if (typeof y !== "undefined") {
                                {# return y.toFixed(2) + " kWh" #}
                                return y.toFixed(2) + " kW"
                            }
                            return y;
                        }
                    },
                    x: {
                        formatter: function (val, timestamp) {
                            {# return moment(new Date(val)).format("DD MMM YYYY") #}
                            return moment(new Date(val)).format("DD MMM YYYY HH:mm")
                        }
                    }
                },
                /*tooltip: {
                    x: {
                    show: false,
                    }
                },*/
                fill: {
                    type:"gradient",
                    gradient: {
                        type: "vertical",
                        shadeIntensity: 1,
                        inverseColors: !1,
                        opacityFrom: .40,
                        opacityTo: .05,
                        stops: [45, 100]
                    }
                },
                noData: {
                    text: 'Data not yet available',
                    align: 'center',
                    verticalAlign: 'middle',
                    offsetX: 0,
                    offsetY: 0,
                    style: {
                        color: undefined,
                        fontSize: '10px',
                        fontFamily: 'Nunito, sans-serif'
                    }
                }
            }
            // w-conso Chart variable
            w_loadChartGenset = new ApexCharts(document.querySelector("#w-load-chart-genset"), loadGenset_options);
            w_loadChartGenset.render()

            var loadDCInput_options = {
                chart: {
                    id: 'kW_DcInput',
                    group: 'loadChart',
                    type: 'area',
                    height: 30,
                    sparkline: {
                        enabled: true
                    },
                    animations:{
                        enabled:false
                    },
                },
                stroke: {
                    curve: 'smooth',
                    width: 2,
                },
                series: [{
                    name: 'Puissance Active',
                    data: {{ dcInputData['kW'] | json_encode | raw }}
                    {# data: [28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 27, 51, 80] #}
                    {# data: [] #}
                }],
                labels: {{ dcInputData['dateP'] | json_encode | raw }},
                {# labels: ['1', '2', '3', '4', '5', '6', '7'], #}
                {# labels: [], #}
                xaxis: {
                    type: 'datetime',
                    //categories: [2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016],
                    categories: [],
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM \'yy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        text: moment().format('MMM YYYY').toString(),
                        style: {
                            fontSize: '14px',
                            fontWeight: 'bold',
                            fontFamily: undefined,
                            color: '#444'
                        },
                    }
                },
                yaxis: {
                    min: 0
                },
                colors: ['#ffc719'],
                tooltip: {
                    theme: "dark",
                    //followCursor: true,
                    y: {
                        formatter: function (y) {
                            //console.log(y)
                            if (typeof y !== "undefined") {
                                return y.toFixed(2) + " kW"
                            }
                            return y;
                        }
                    },
                    x: {
                        formatter: function (val, timestamp) {
                            return moment(new Date(val)).format("DD MMM YYYY HH:mm")
                        }
                    }
                },
                /*tooltip: {
                    x: {
                    show: false,
                    }
                },*/
                fill: {
                    type:"gradient",
                    gradient: {
                        type: "vertical",
                        shadeIntensity: 1,
                        inverseColors: !1,
                        opacityFrom: .40,
                        opacityTo: .05,
                        stops: [45, 100]
                    }
                },
                noData: {
                    text: 'Data not yet available',
                    align: 'center',
                    verticalAlign: 'middle',
                    offsetX: 0,
                    offsetY: 0,
                    style: {
                        color: undefined,
                        fontSize: '10px',
                        fontFamily: 'Nunito, sans-serif'
                    }
                }
            }
            // w-load Chart DC Input variable
            w_loadChartDCInput = new ApexCharts(document.querySelector("#w-load-chart-dcInput"), loadDCInput_options);
            w_loadChartDCInput.render()

            var voltBatt_options = {
                chart: {
                    id: 'volt_Batt',
                    group: 'voltChart',
                    type: 'area',
                    height: 30,
                    sparkline: {
                        enabled: true
                    },
                    animations:{
                        enabled:false
                    },
                },
                stroke: {
                    curve: 'smooth',
                    width: 2,
                },
                series: [{
                    name: 'Tension',
                    data: {{ dcData['voltageProfileData']['volt'] | json_encode | raw }}
                    {# data: [28, 40, 36, 52, 38, 60, 38, 28] #}
                    {# data: [] #}
                }],
                labels: {{ dcData['voltageProfileData']['date'] | json_encode | raw }},
                {# labels: ['1', '2', '3', '4', '5', '6', '7'], #}
                {# labels: [], #}
                xaxis: {
                    type: 'datetime',
                    {#categories: ['2009-01-14 15:20:22', '2010-01-14 15:20:22', '2011-01-14 15:20:22', '2012-01-14 15:20:22', '2013-01-14 15:20:22', '2014-01-14 15:20:22', '2015-01-14 15:20:22', '2016-01-14 15:20:22'],
                    categories: [],#}
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM \'yy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        text: moment().format('MMM YYYY').toString(),
                        style: {
                            fontSize: '14px',
                            fontWeight: 'bold',
                            fontFamily: undefined,
                            color: '#444'
                        },
                    }
                },
                yaxis: {
                    min: 0
                },
                colors: ['#1b55e2'],
                tooltip: {
                    theme: "dark",
                    //followCursor: true,
                    y: {
                        formatter: function (y) {
                            //console.log(y)
                            if (typeof y !== "undefined") {
                                return y.toFixed(2) + " V"
                            }
                            return y;
                        }
                    },
                    x: {
                        formatter: function (val, timestamp) {
                            return moment(new Date(val)).format("DD MMM YYYY HH:mm")
                        }
                    }
                },
                /*tooltip: {
                    x: {
                    show: false,
                    }
                },*/
                fill: {
                    type:"gradient",
                    gradient: {
                        type: "vertical",
                        shadeIntensity: 1,
                        inverseColors: !1,
                        opacityFrom: .40,
                        opacityTo: .05,
                        stops: [45, 100]
                    }
                },
                noData: {
                    text: 'Data not yet available',
                    align: 'center',
                    verticalAlign: 'middle',
                    offsetX: 0,
                    offsetY: 0,
                    style: {
                        color: undefined,
                        fontSize: '10px',
                        fontFamily: 'Nunito, sans-serif'
                    }
                }
            }
            // w-volt Batt Chart variable
            w_voltChartBatt = new ApexCharts(document.querySelector("#w-volt-chart-batt"), voltBatt_options);
            w_voltChartBatt.render()

            var loadChart_options = {
                chart: {
                    id: 'kW_Load',
                    group: 'loadChart',
                    type: 'area',
                    height: 30,
                    sparkline: {
                        enabled: true
                    },
                    animations:{
                        enabled:false
                    },
                },
                stroke: {
                    curve: 'smooth',
                    width: 2,
                },
                series: [{
                    {# name: 'Énergie Active', #}
                    name: 'Puissance Active',
                    {# data: {{ loadSiteData['kWh'] | json_encode | raw }} #}
                    data: {{ loadSiteData['kW'] | json_encode | raw }}
                    {# data: [28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 28, 40, 36, 52, 38, 60, 38, 27, 51, 80] #}
                }],
                {# labels: {{ loadSiteData['date'] | json_encode | raw }}, #}
                labels: {{ loadSiteData['dateP'] | json_encode | raw }},
                {# labels: ['1', '2', '3', '4', '5', '6', '7'], #}
                xaxis: {
                    type: 'datetime',
                    //categories: [2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016],
                    categories: [],
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM \'yy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        text: moment().format('DD MMMM').toString(),
                        style: {
                            fontSize: '14px',
                            fontWeight: 'bold',
                            fontFamily: undefined,
                            color: '#444'
                        },
                    }
                },
                yaxis: {
                    min: 0
                },
                colors: ['#7030A0'],
                tooltip: {
                    theme: "dark",
                    //followCursor: true,
                    y: {
                        formatter: function (y) {
                            //console.log(y)
                            if (typeof y !== "undefined") {
                                {# return y.toFixed(2) + " kWh" #}
                                return y.toFixed(2) + " kW"
                            }
                            return y;
                        }
                    },
                    x: {
                        formatter: function (val, timestamp) {
                            {# return moment(new Date(val)).format("DD MMM YYYY") #}
                            return moment(new Date(val)).format("DD MMM YYYY HH:mm")
                        }
                    }
                },
                /*tooltip: {
                    x: {
                    show: false,
                    }
                },*/
                fill: {
                    type:"gradient",
                    gradient: {
                        type: "vertical",
                        shadeIntensity: 1,
                        inverseColors: !1,
                        opacityFrom: .40,
                        opacityTo: .05,
                        stops: [45, 100]
                    }
                },
                noData: {
                    text: 'Data not yet available',
                    align: 'center',
                    verticalAlign: 'middle',
                    offsetX: 0,
                    offsetY: 0,
                    style: {
                        color: undefined,
                        fontSize: '10px',
                        fontFamily: 'Nunito, sans-serif'
                    }
                }
            }
            // w-conso Chart variable
            w_loadChart = new ApexCharts(document.querySelector("#w-load-chart"), loadChart_options);
            w_loadChart.render()            
            
        }, 500)
        resolve('load chart render')

    }).then(function(elem){
        //$('#load-chart-loader').addClass('d-none')
    });
            
    //})

    
    function progress(prefixSelector, progValue, posLogique, isTime) {
        
        var id = '#' + prefixSelector;
        var progressSelectorValue = $(id + 'value');
        var progressSelectorColor = $(id + 'color');
        var upSelectorIcon        = $(id + 'up-icon');
        var downSelectorIcon      = $(id + 'down-icon');
        var greenColor            = 'text-success';
        var redColor              = 'text-danger';
        
        if (!isTime) {//On teste s'il s'agit d'une progression numérique 
            var val = progValue !== 'INF' ? String(parseFloat(progValue).toFixed(2)) : progValue;
            progressSelectorValue.html(progValue === null ? 0 : (progValue > 0 || progValue === 'INF') ? ('+' + val) : val);
        }
        else {//s'il s'agit d'une progression de date
            var diff = new Date(Math.abs(progValue));
            var $dat = new moment(diff).subtract(timeZoneOffset, 'hours');
            var str = $dat.format('HH:mm:ss').toString()
            progressSelectorValue.html(progValue === null ? 0 : progValue > 0 ? '+' + str : '-' + str);
        }

        if (posLogique) {// Logique positive
            if (progValue > 0 || progValue === 'INF') {//Si la valeur de progression est positive
                //On met la valeur et l'îcone en vert
                progressSelectorColor.removeClass(redColor).addClass(greenColor);

                //On affiche l'îcone svg arrow-up
                upSelectorIcon.removeClass('d-none');

                //On masque l'îcone svg arrow-down
                downSelectorIcon.addClass('d-none');

                /*if (selectorIcon.hasClass(oldClass)) {
                    // it has class
                } else {
                    // it doesn't have specified class
                }*/
            }
            else {//Si la valeur de progression est négative
                //On met la valeur et l'îcone en rouge
                progressSelectorColor.removeClass(greenColor).addClass(redColor);

                //On affiche l'îcone svg arrow-down
                downSelectorIcon.removeClass('d-none');

                //On masque l'îcone svg arrow-up
                upSelectorIcon.addClass('d-none');
            }
        }
        else {// Logique négative
            if (progValue > 0 || progValue === 'INF') {//Si la valeur de progression est positive
                
                //On met la valeur et l'îcone en rouge
                progressSelectorColor.removeClass(greenColor).addClass(redColor);
                
                //On affiche l'îcone svg arrow-up
                upSelectorIcon.removeClass('d-none');

                //On masque l'îcone svg arrow-down
                downSelectorIcon.addClass('d-none');

            }
            else {//Si la valeur de progression est négative
                
                //On met la valeur et l'îcone en vert
                progressSelectorColor.removeClass(redColor).addClass(greenColor);
                
                //On affiche l'îcone svg arrow-down
                downSelectorIcon.removeClass('d-none');

                //On masque l'îcone svg arrow-up
                upSelectorIcon.addClass('d-none');
                
            }
        }
    }

    setTimeout(getClimateData, 100);

    function getClimateData(){
        // My key 4e7cd8803316af415207236c1b888ba3
        var key = "4532cfe7e35c05d1290279dd42fe18bd"
        
        var url = "http://api.openweathermap.org/data/2.5/onecall?lat={{site.latitude}}&lon={{site.longitude}}&units=metric&exclude=hourly,daily&appid=" + key;
        $.getJSON(url, function (result) {//{'selectedDate': $date},
            console.log(result)
            if( Object.keys(result).length > 0 ){ 
                //Température en °C
                $('#w-temp').text(String(parseFloat(result['current']['temp']).toFixed(2)))
          
                //Humidité relative
                $('#w-hum').text(String(parseFloat(result['current']['humidity']).toFixed(2)))

                //Display weather icon
                var iconcode = result['current']['weather'][0]['icon'];
                var iconurl = "http://openweathermap.org/img/w/" + iconcode + ".png";
                $('#wicon').attr('src', iconurl);
            }        
            else{
                //$('.spin').addClass('d-none');
                
            }
        }).fail(function() { 
            
            console.log('FAIL to get Climate Data')
            
        });
                 
    }
    
    setInterval(function () {
        $.getJSON("{{ path('site_pro_dc_overview_update_data', {'slug': site.slug}) }}", function (result) {//{'selectedDate': $date},
            
            if( Object.keys(result).length > 0 ){
                console.log(result)

                {# $('#last_update').text(String( moment( new Date(result['gensetData']['last_update']) ).format("DD MMM YYYY HH:mm:ss")) ) #}
                $('#last_update').text(result['gensetData']['last_update']);
                
                //++++ Mise à jour des données de la card GRID du mois cours
                //Valeur de la puissance active en cours du GRID
                if(result['gensetData']['CGCR']['CR']){
                    $('#grid-kW').text(String(parseFloat(result['gensetData']['Power']).toFixed(2)))

                }else{
                    $('#grid-kW').text(String(parseFloat(0.0)));

                }
                //Valeur de la fourniture d'énergie active provenant du GRID pour le mois en cours
                $('#w-grid-fourniture').text(String(parseFloat(result['gridData']['totalKWh']).toFixed(2)))
                //Pourcentage de contribution d'énergie active du GRID pour le mois en cours
                $('#w-grid-contrib').text(String(parseFloat(result['gridData']['contrib']).toFixed(2)))
                //Facteur de puissance d'énergie provenant du GRID pour le mois en cours
                $('#w-grid-fp').text(String(parseFloat(result['gridData']['FP']).toFixed(2)))
                //Puissance max provenant du GRID pour le mois en cours
                $('#w-grid-pmax').text(String(parseFloat(result['gridData']['Pmax']).toFixed(2)))
                {# //MAJ de la courbe d'évolution de la fourniture en kWh jour après jour provenant du GRID
                displayNewData(w_loadChartGrid, Object.values(result['gridData']['date']), Object.values(result['gridData']['kWh']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day'); #}
                //MAJ de la courbe d'évolution de la courbe de charge en kW du GRID
                displayNewData(w_loadChartGrid, Object.values(result['gridData']['dateP']), Object.values(result['gridData']['kW']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day');
                
                {% if hasgensetMod %}
                    //++++ Mise à jour des données de la card GENSET du mois cours

                    //Valeur de la puissance active en cours du GENSET
                    if(result['gensetData']['CGCR']['CG']){
                        $('#genset-kW').text(String(parseFloat(result['gensetData']['Power']).toFixed(2)))
                    }else{
                        $('#genset-kW').text(String(parseFloat(0.0)));
                    }
                    //Valeur de la fourniture d'énergie active provenant du GENSET pour le mois en cours
                    $('#w-genset-fourniture').text(String(parseFloat(result['gensetData']['currentTEP']).toFixed(2)))
                    //Pourcentage de contribution d'énergie active du GENSET pour le mois en cours
                    $('#w-genset-contrib').text(String(parseFloat(result['contriGensetKWh']).toFixed(2)))
                    //Consommation de Fuel du GENSET pour le mois en cours
                    $('#w-genset-conso-fuel').text(String(parseFloat(result['gensetData']['currentConsoFuel']).toFixed(2)))
                    //Charge max du GENSET pour le mois en cours
                    $('#w-genset-load-max').text(String(parseFloat(result['gensetData']['loadMax']).toFixed(2)))
                    {# //MAJ de la courbe d'évolution de la fourniture en kWh jour après jour provenant du GENSET
                    displayNewData(w_loadChartGenset, Object.values(result['gensetData']['dayBydayTEPData']['date']), Object.values(result['gensetData']['dayBydayTEPData']['TEP']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day'); #}
                    //MAJ de la courbe d'évolution de la courbe de charge en kW du GENSET
                    displayNewData(w_loadChartGenset, Object.values(result['gensetData']['loadProfileData']['date']), Object.values(result['gensetData']['loadProfileData']['kW']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day');
                {% endif %}
                             
                //++++ Mise à jour des données de la card LOAD du mois cours
                //Valeur de la puissance active en cours de la charge
                {# $('#load-kW').text(String(parseFloat(result['gensetData']['Power']).toFixed(2))) #}

                //Valeur de la Consommation d'énergie active de la charge pour le mois en cours
                $('#w-load-conso').text(String(parseFloat(result['loadSiteData']['totalKWh']).toFixed(2)))
                
                //Facteur de puissance de la charge pour le mois en cours
                $('#w-load-fp').text(String(parseFloat(result['loadSiteData']['FP']).toFixed(2)))
                
                //Puissance max de la charge pour le mois en cours
                $('#w-load-pmax').text(String(parseFloat(result['loadSiteData']['Pmax']).toFixed(2)))
                
                {# //MAJ de la courbe d'évolution de la fourniture en kWh jour après jour de la charge
                displayNewData(w_loadChart, Object.values(result['loadSiteData']['date']), Object.values(result['loadSiteData']['kWh']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day'); #}
                //MAJ de la courbe d'évolution de la courbe de charge en kW de l'installation
                displayNewData(w_loadChart, Object.values(result['loadSiteData']['dateP']), Object.values(result['loadSiteData']['kW']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day');

                //++++ Mise à jour des données de la card DC Input du mois cours
                //Valeur de la puissance active en cours du DC Input

                //Valeur de la fourniture d'énergie active provenant du DC Input pour le mois en cours
                $('#w-dcInput-fourniture').text(String(parseFloat(result['dcInputData']['totalKWh']).toFixed(2)))
                //Pourcentage de contribution d'énergie active du DC Input pour le mois en cours
                $('#w-dcInput-contrib').text(String(parseFloat(result['dcInputData']['contrib']).toFixed(2)))
                //Facteur de puissance d'énergie provenant du DC Input pour le mois en cours
                {# $('#w-dcInput-fp').text(String(parseFloat(result['dcInputData']['FP']).toFixed(2))) #}
                //Puissance max provenant du DC Input pour le mois en cours
                $('#w-dcInput-pmax').text(String(parseFloat(result['dcInputData']['Pmax']).toFixed(2)))
                {# //MAJ de la courbe d'évolution de la fourniture en kWh jour après jour provenant du DC Input
                displayNewData(w_loadChartGrid, Object.values(result['dcInputData']['date']), Object.values(result['dcInputData']['kWh']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day'); #}
                //MAJ de la courbe d'évolution de la courbe de charge en kW du DC Input
                displayNewData(w_loadChartDCInput, Object.values(result['dcInputData']['dateP']), Object.values(result['dcInputData']['kW']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day');

                //++++ Mise à jour des données de la card Battérie
                //Tension de le parc battérie
                $('#w-batt-volt').text(String(parseFloat(result['dcData']['BattVolt']).toFixed(2)))
                //Valeur de l'énergie disponible dans le parc battérie
                $('#w-batt-dispo').text(String(parseFloat(result['dcData']['BattEnergy']).toFixed(2)))
                //Gestion de l'état (en charge ou décharge ) du parc battérie
                if(result['dcData']['BattState']){
                    if($('#w-batt-state').hasClass('text-danger')) $('#w-batt-state').removeClass('text-danger')
                    $('#w-batt-state').addClass('text-success')
                    $('#w-batt-state').text('En Charge')
                }
                else{
                    if($('#w-batt-state').hasClass('text-success')) $('#w-batt-state').removeClass('text-success')
                    $('#w-batt-state').addClass('text-danger')
                    $('#w-batt-state').text('Décharge')
                }
                //MAJ de la courbe d'évolution de la tension de la battérie
                displayNewData(w_voltChartBatt, Object.values(result['dcData']['voltageProfileData']['date']), Object.values(result['dcData']['voltageProfileData']['volt']), [moment().format("DD MMM YYYY"), moment().format("DD MMM YYYY")], 1, 'day');

                //++++ Mise à jour des données de la card d'émission de carbone du mois cours
                //Empreinte carbonne pour le mois en cours
                $('#w-emission-value').text(String(parseFloat(result['kgCO2']).toFixed(2)))
                               
                
            }        
            else{
                //$('.spin').addClass('d-none');
                
            }
        }).fail(function() { 
            
            console.log('FAIL to get overview Data')
            
        });
    }, 120000);
//
</script>

<!-- Script de gestion du sélecteur de date -->
<script>

    var _url = "{{ path('site_pro_dc_histo_update', {'slug':site.slug}) }}";

    var ContribChart_options = {
        chart: {
            fontFamily: 'Nunito, sans-serif',
            width: 300,
            type: 'pie',
        },
        colors: ["#53e21b","#e26b1b","#FFC737","#1b55e2"],
        {# series: [55, 45, 13, 5], #}
        series: [0, 0, 0],
        labels: ['From Grid ', 'From Genset ', 'From DC Input '],
        legend: {
            position: 'bottom',
            horizontalAlign: 'center', 
            //offsetY: 40
        },
        responsive: [{
          breakpoint: 480,
          options: {
            /*chart: {
              width: 300
            },*/
            legend: {
              position: 'bottom',
             // show: false,
            }
          }
        }],
        tooltip: {
            followCursor: true,
            shared: false,
            theme: "dark",
            //followCursor: true,
            y: {
                formatter: function (y) {
                    //console.log(y)
                    if (typeof y !== "undefined") {
                        return y.toFixed(2) + " kWh"
                    }
                    return y;
                }
            },
            /*x: {
                formatter: function (val, timestamp) {
                    return moment(new Date(val)).format("DD MMM YYYY")
                }
            }*/
        }
    };

    var ContribChart = new ApexCharts(document.querySelector("#contri-source"), ContribChart_options);
    ContribChart.render();

    var MixedConsoChart_options = {
        series: [{
            name: 'From Grid ',
            {# data: [44, 55, 41, 67, 22, 43] #}
            data: []
            }, {
            name: 'From Genset ',
            {# data: [13, 23, 20, 8, 13, 27] #}
            data: []
            }, {
            name: 'From DC Input ',
            {# data: [11, 17, 15, 15, 21, 14] #}
            data: []
            }, {
            name: ' ',
            {# data: [11, 17, 15, 15, 21, 14] #}
            data: []
        }],
        chart: {
            fontFamily: 'Nunito, sans-serif',
            type: 'bar',
            height: 350,
            stacked: true,
            toolbar: {
                show: true
            },
            zoom: {
                enabled: true
            }
        },
        colors: ["#53e21b","#e26b1b","#FFC737","#1b55e2"],
        responsive: [{
          breakpoint: 480,
          options: {
            legend: {
              position: 'bottom',
              offsetX: -10,
              offsetY: 0
            }
          }
        }],
        plotOptions: {
          bar: {
            horizontal: false,
            borderRadius: 10
          },
        },
        xaxis: {
            type: 'datetime',
            //categories: [],
            categories: ['01/01/2011 GMT', '01/02/2011 GMT', '01/03/2011 GMT', '01/04/2011 GMT',
                '01/05/2011 GMT', '01/06/2011 GMT'
            ],
            labels: {
                datetimeFormatter: {
                    year: 'yyyy',
                    month: 'MMM \'yy',
                    day: 'dd MMM',
                    hour: 'HH:mm'
                }
            },
        },
        yaxis: [
            {
                axisTicks: {
                    show: true,
                },
                axisBorder: {
                    show: true,
                    color: '#5c1ac3'
                },
                labels: {
                    style: {
                        color: '#5c1ac3',
                    }
                },
                title: {
                    text: "kWh"
                },
            }
        ],
        legend: {
          position: 'bottom',
          //offsetY: 1
        },
        fill: {
          opacity: 1
        },
        dataLabels: {
            enabled: true,
            offsetY: 40,
            style: {
                fontSize: '12px',
                colors: ["#304758"]
            },
            formatter: function(value, { seriesIndex, dataPointIndex, w}) {
                //return w.globals.stackedSeriesTotals[dataPointIndex];
                if (seriesIndex === ((w.config.series.length) - parseInt(1)))
                    return w.globals.stackedSeriesTotals[dataPointIndex];
                return "";//value + " kWh";
                /*formatter: function(value, { seriesIndex, dataPointIndex, w}) {
                    let indices = w.config.series.map((item, i) => i);
                    console.log("indices = " + indices);
                    indices = indices.filter(i => !w.globals.collapsedSeriesIndices.includes(i) && _.get(w.config.series, `${i}.data.${dataPointIndex}`) > 0);
                    console.log("indices = " + indices);
                    if (seriesIndex == _.max(indices))
                        return w.globals.stackedSeriesTotals[dataPointIndex];
                    return '';
                }*/
            }
        },
        tooltip: {
            followCursor: true,
            shared: true,
            intersect: false,
            /*custom: function({ series, seriesIndex, dataPointIndex, w }) {
                let currentTotal = 0
                series.forEach((s) => {
                    currentTotal += s[dataPointIndex]
                })
                return '<div class="custom-tooltip">' +
                '<span><b>Total: </b>' + currentTotal + '</span>' +
                '</div>'
            },*/
            theme: "dark",
            //followCursor: true,
            y: {
                formatter: function (y) {
                    //console.log(y)
                    if (typeof y !== "undefined") {
                        return y.toFixed(2) + " kWh"
                    }
                    return y;
                }
            },
            x: {
                formatter: function (val, timestamp) {
                    if(startDate === endDate){
                        {# console.log('startDate = ' + startDate);
                        console.log('endDate = ' + endDate); #}

                        return moment(new Date(val)).format("DD MMM YYYY HH:mm")
                    }
                    return moment(new Date(val)).format("DD MMM YYYY")
                }
            }
        }
        /*tooltip: {
            shared: true,
            intersect: false,
        }*/
    };

    var MixedConsoChart = new ApexCharts(document.querySelector("#conso"), MixedConsoChart_options);
    MixedConsoChart.render();

    {# var start = moment().subtract(1, 'days');
     var end = moment(); #}

    var start = moment().startOf('month');
    var end = moment().endOf('month');

    function cb(start, end) {
        $('#daterange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }

    $('#daterange').daterangepicker({
        startDate: start,
        endDate: end,
        maxSpan: {
            "days": 31
        },
        maxDate: moment().endOf('month'),
        ranges: {
            'Today': [moment(), moment()],
            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
            'This Month': [moment().startOf('month'), moment().endOf('month')],
            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    var drp = $('#daterange').data('daterangepicker');
    console.log('drp = ' + drp.startDate.format('YYYY-MM-DD'));
    var startDate = drp.startDate.format('YYYY-MM-DD');
    var endDate = drp.endDate.format('YYYY-MM-DD');   

    $('#daterange').on('apply.daterangepicker', function (ev, picker) {
        //console.log(picker.startDate.format('YYYY-MM-DD'));
        //console.log(picker.endDate.format('YYYY-MM-DD'));
    
        startDate = picker.startDate.format('YYYY-MM-DD');
        endDate = picker.endDate.format('YYYY-MM-DD');
        
        updateHistoGraphs();
        // block of code that runs when the click event triggers

    });

    function displayNewData(chart, label, data, dateopt, multiple, xscale){
        //chart.data.labels = [];
        chart.updateOptions({
            xaxis: {
                categories: []
            },
        });
        chart.updateOptions({
            xaxis: {
                categories: label
            },
        });
        //chart.opts.labels = label;
        /* chart.updateOptions({
            labels: label
            
        }); */
        if(multiple > 1){
            var i = 0;
            chart.opts.series.forEach((dataset) => {
                if( i < multiple){
                    dataset.data = [];
                    console.log(dataset.name);
                    console.log(dataset.data);
                    dataset.data = data[i];
                    console.log(data[i]);
                    console.log(dataset.data);
                    i++;
                }
            });
        }
        else if(multiple == 1){
            chart.updateSeries([{
                data: []
            }]);
        
            chart.updateSeries([{
                data: data
            }]);
        }

        /*if(xscale === 'day'){
            chart.updateOptions({
                xaxis: {
                    title: {
                        //text: moment(dateopt).format('DD MMMM').toString(),
                        text: moment(dateopt[0]).format('DD MMMM YYYY').toString() + ' - ' + moment(dateopt[1]).format('DD MMMM YYYY').toString(),
                    }
                },
            });
        }
        else if( xscale === 'month'){
            chart.updateOptions({
                xaxis: {
                    title: {
                        text: moment(dateopt[0]).format('MMMM YYYY').toString() + ' - ' + moment(dateopt[1]).format('MMMM YYYY').toString(),
                    }
                },
            });
        }*/
        //console.log(chart.options.scales.xAxes[0].scaleLabel.labelString);
        //preloaderChart(id, false);
        //chart.render();
    }            

    function updateDonutChart(chart, label, data) {
        chart.updateOptions({labels: label});
        chart.updateSeries(newDataSeries(chart, data));
    }
    
    function newDataSeries(chart, data) {
        var i = 0;
        return chart.w.globals.series.map(function () {
            return data[i++];
        });
    }

    function updateHistoGraphs(){
        
        $data = JSON.stringify({
            //"selectedDate": $dat, // tabGridId,
            "startDate": startDate + ' 00:00:00', // tabGridId,
            "endDate": endDate + '23:59:59', // tabFuelId,
        });
        
        swal.queue([{
            title: 'Les graphes seront actualisés pour la période :',
            confirmButtonText: 'Confirmer',
            cancelButtonText: 'Annuler',
            text: 'Du ' + startDate + ' Au ' + endDate,
            showCancelButton: true,
            showLoaderOnConfirm: true,
            //confirmButtonClass: 'btn btn-primary',
            //cancelButtonClass: 'btn btn-danger ml-2',
            preConfirm: function () {
                return new Promise(function (resolve) { 
                    
                    $.ajax({
                        type: "POST", // method type
                        contentType: "application/json; charset=utf-8",
                        url: _url, // /Target function that will be return result
                        data: $data, // parameter pass data is parameter name param is value
                        dataType: "json",
                        timeout: 120000, // 64241
                        success: function (result) {
                            // $('.fa-sync').removeClass('fa-spin');
                            console.log(result);
                            
                            swal({
                                type: 'success', 
                                title: 'Les graphes ont été mis !',
                                // html: 'Submitted email: ' + email
                            });

                            setTimeout(function () {
                                resolve()
                            }, 1500);

                            if( Object.keys(result).length > 0 ){
                                $('#total-conso').text(parseFloat(result['totalkWh']).toFixed(2))
                                console.log(Object.values(result['Mixed_Conso']))
                                
                                {# MixedConsoChart.destroy()
                                MixedConsoChart = new ApexCharts(
                                    document.querySelector("#conso"),
                                    MixedConsoChart_options
                                );
                                MixedConsoChart.render() #}
                                displayNewData(MixedConsoChart, result['Mixed_Conso']['date'], Object.values(result['Mixed_Conso']['conso']), [startDate, endDate], 4, 'day');
                                {# MixedConsoChart.toggleSeries('From Grid ')
                                MixedConsoChart.toggleSeries('From Grid ')
                                MixedConsoChart.toggleSeries('From Genset ')
                                MixedConsoChart.toggleSeries('From Genset ')
                                MixedConsoChart.toggleSeries('From DC Input ')
                                MixedConsoChart.toggleSeries('From DC Input ')
                                MixedConsoChart.toggleSeries('From Battery ')
                                MixedConsoChart.toggleSeries('From Battery ') #}
                                MixedConsoChart.toggleSeries(' ')
                                MixedConsoChart.toggleSeries(' ')


                                updateDonutChart(ContribChart, ['From Grid', 'From Genset', 'From DC Input'], Object.values(result['pieChart']))
                            }
                        },
                        error: function (result) {
                            // console.log("Error");
                            // console.log(result);
                            swal('Oups...', "Une erreur s'est produite !", 'error'
                            // footer: '<a href>Why do I have this issue?</a>'
                            );

                            setTimeout(function () {
                                resolve()
                            }, 5000);
                        }
                    });
                })
            },
            allowOutsideClick: false
        }]);
    }

    setTimeout(function(){
        var drp_ = $('#gendaterange').data('daterangepicker');
        console.log('drp = ' + drp.startDate.format('YYYY-MM-DD'));
        var startDate_ = drp.startDate.format('YYYY-MM-DD');
        var endDate_ = drp.endDate.format('YYYY-MM-DD');

        $data = JSON.stringify({
        //"selectedDate": $dat, // tabGridId,
        "startDate": startDate_ + ' 00:00:00', // tabGridId,
        "endDate": endDate_ + '23:59:59', // tabFuelId,
        });

        // Danger

        swal.queue([{
            title: 'Chargement...',
            confirmButtonText: 'Confirmez',
            text: 'Veuillez patienter svp !',
            //showCancelButton: true,
            showLoaderOnConfirm: true,
            //confirmButtonClass: 'btn btn-primary',
            //cancelButtonClass: 'btn btn-danger ml-2',
        
            //title: 'The graphs will be updated for the date range :',
            //confirmButtonText: 'Confirm',
            //text: 'From ' + startDate_ + ' To ' + endDate_,
            //showCancelButton: true,
            //showLoaderOnConfirm: true,
            //confirmButtonClass: 'btn btn-primary',
            //cancelButtonClass: 'btn btn-danger ml-2',
            preConfirm: function () {
                return new Promise(function (resolve) { 
                    
                    $.ajax({
                        type: "POST", // method type
                        contentType: "application/json; charset=utf-8",
                        url: _url, // /Target function that will be return result
                        data: $data, // parameter pass data is parameter name param is value
                        dataType: "json",
                        timeout: 120000, // 64241
                        success: function (result) {
                            // $('.fa-sync').removeClass('fa-spin');
                            console.log(result);
                            
                            swal({
                                type: 'success', 
                                title: 'Les graphes ont été mis !',
                                // html: 'Submitted email: ' + email
                            });

                            setTimeout(function () {
                                resolve()
                            }, 1500);

                            if( Object.keys(result).length > 0 ){
                                $('#total-conso').text(parseFloat(result['totalkWh']).toFixed(2))
                                console.log(Object.values(result['Mixed_Conso']))
                                
                                {# MixedConsoChart.destroy()
                                MixedConsoChart = new ApexCharts(
                                    document.querySelector("#conso"),
                                    MixedConsoChart_options
                                );
                                MixedConsoChart.render() #}
                                displayNewData(MixedConsoChart, result['Mixed_Conso']['date'], Object.values(result['Mixed_Conso']['conso']), [startDate, endDate], 4, 'day');
                                {# MixedConsoChart.toggleSeries('From Grid ')
                                MixedConsoChart.toggleSeries('From Grid ')
                                MixedConsoChart.toggleSeries('From Genset ')
                                MixedConsoChart.toggleSeries('From Genset ')
                                MixedConsoChart.toggleSeries('From DC Input ')
                                MixedConsoChart.toggleSeries('From DC Input ')
                                MixedConsoChart.toggleSeries('From Battery ')
                                MixedConsoChart.toggleSeries('From Battery ') #}
                                MixedConsoChart.toggleSeries(' ')
                                MixedConsoChart.toggleSeries(' ')

                                updateDonutChart(ContribChart, ['From Grid', 'From Genset', 'From DC Input'], Object.values(result['pieChart']))
                            }
                        },
                        error: function (result) {
                            // console.log("Error");
                            // console.log(result);
                            swal('Oups...', "Une erreur s'est produite !", 'error'
                            // footer: '<a href>Why do I have this issue?</a>'
                            );

                            setTimeout(function () {
                                resolve()
                            }, 5000);
                        }
                    });
                })
            },
            allowOutsideClick: false
        }]); 

        $(".swal2-confirm").click();

    }, 200)

</script> 
{% endblock %}
